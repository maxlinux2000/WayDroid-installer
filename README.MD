# üöÄ Instalador One-Click de Waydroid con Google Play Services para Debian 12

## üìù Descripci√≥n del Proyecto

Este proyecto proporciona un instalador auto-extra√≠ble de un solo clic (`.run`) dise√±ado para simplificar la configuraci√≥n completa de **Waydroid** en sistemas Debian 12 (Bookworm) y sus derivadas.

El objetivo es automatizar los pasos de instalaci√≥n, configuraci√≥n del *firewall* (UFW) y, lo m√°s importante, facilitar la activaci√≥n de **Google Play Services** (Play Store) mediante el proceso de registro del Android ID.

### Compatibilidad y Arquitectura

* **Sistema Operativo:** Debian 12 (Bookworm) y derivadas (ej. Ubuntu, Mint).
* **Arquitectura Soportada:** **AMD64** (procesadores Intel/AMD).
* **‚ö†Ô∏è Aviso de Compatibilidad ARM64:** Esta versi√≥n del script **no ha sido probada y no se garantiza que funcione** correctamente en arquitecturas **ARM64** (ej. Raspberry Pi 5), debido a variaciones en la instalaci√≥n del *kernel* de `binder_linux` y `anbox-modules-dkms`.

## üì¶ Componentes Generados

El instalador genera autom√°ticamente los siguientes componentes clave en el sistema:

1.  **Waydroid GPlay Services Activator:** Un lanzador que ejecuta un *script* en terminal para obtener el Android ID necesario para el registro.
2.  **Waydroid Restart:** Un lanzador para detener y reiniciar la sesi√≥n de Waydroid de forma segura (`stop` -> `sleep 3` -> `start`).

## ‚öôÔ∏è Gu√≠a de Uso del Instalador

### Paso 1: Obtener y Ejecutar el Instalador

1.  Descargue el archivo `waydroid_installer_YYYY-MM-DD.run` (generado por `create_waydroid_run.sh`).
2.  Dele permisos de ejecuci√≥n y ejec√∫telo desde la terminal (se elevar√° autom√°ticamente a `sudo`):

    ```bash
    chmod +x waydroid_installer_*.run
    ./waydroid_installer_*.run
    ```
3.  Siga las instrucciones en la terminal. El *script* instalar√° todas las dependencias, Waydroid, configurar√° UFW y, al finalizar, le preguntar√° si desea **reiniciar** el sistema. **Se recomienda reiniciar.**

### Paso 2: Obtener y Registrar el Android ID

Este es el paso crucial para activar Google Play Store.

1.  **Inicie Waydroid:** Busque en su men√∫ de aplicaciones "Waydroid" y ejec√∫talo (**Waydroid show-full-ui**) una vez para que se cree la base de datos necesaria para el Android ID. Luego ci√©rrelo.
2.  **Ejecute el Lanzador Activador:** Busque en el men√∫ de aplicaciones:
    * **`Waydroid GPlay Services Activator`**
3.  El lanzador abrir√° una terminal que le pedir√° su contrase√±a de `sudo`.
4.  La terminal mostrar√° la **Android ID** de 16 d√≠gitos.
5.  Siga las instrucciones que aparecen en la terminal:
    * Copie la **Android ID**.
    * Abra el enlace de registro de Google: `https://www.google.com/android/uncertified`
    * Pegue la ID en el campo **Google Services Framework Android ID** y pulse **'Register'**.

### Paso 3: Reiniciar la Sesi√≥n de Waydroid

Despu√©s de registrar la ID en el sitio web de Google, espere unos minutos (a veces 1-2 minutos) para que el registro se propague. Luego, debe reiniciar la sesi√≥n de Waydroid.

1.  Busque en el men√∫ de aplicaciones:
    * **`Waydroid Restart`**
2.  Este lanzador detendr√° la sesi√≥n de Waydroid, esperar√° 3 segundos y la volver√° a iniciar (`waydroid session stop` -> `waydroid session start`).

Una vez completado, inicie Waydroid de nuevo. Google Play Store deber√≠a estar disponible y funcionando correctamente.

## üíª Bloques de C√≥digo de Referencia

Aqu√≠ est√°n los *scripts* principales para referencia y mantenimiento.

### `create_waydroid_run.sh`

```bash
#!/bin/bash
# create_waydroid_run.sh
# Genera el archivo ejecutable one-click 'waydroid_installer.run' (SOLO TERMINAL)

DATE=$(date '+%Y-%m-%d')

set -e

OUTPUT_FILE="waydroid_installer_$DATE.run"

echo "üõ†Ô∏è Generando el instalador auto-extra√≠ble: $OUTPUT_FILE (SOLO TERMINAL y Launcher de Reinicio)"

# -----------------------------------------------------------------------------
# 1. Crear el Wrapper de Inicio
# -----------------------------------------------------------------------------
cat > "$OUTPUT_FILE" << 'EOF_WRAPPER'
#!/bin/bash
# Waydroid Installer - Script auto-extra√≠ble
# -----------------------------------------------------------------------------
set -e

# Marcador que indica d√≥nde empieza el payload (¬°NO CAMBIAR ESTA L√çNEA!)
PAYLOAD_LINE=$(awk '/^# --- PAYLOAD START ---$/ {print NR + 1; exit 0; }' "$0")
WAYDROID_USER=$(logname)

# Comprobar si se est√° ejecutando como root
if [ "$(id -u)" -ne 0 ]; then
    echo "üö® Este script debe ejecutarse con permisos de root (sudo)."
    echo "Pediremos sudo para continuar."
    
    # Intentar re-ejecutar el script con sudo
    exec sudo "$0" "$@"
    
    if [ "$(id -u)" -ne 0 ]; then
        echo "‚ùå No se pudieron obtener permisos de root. Abortando."
        exit 1
    fi
fi

# Directorio temporal y nombre del payload
TMP_DIR=$(mktemp -d)
PAYLOAD_SCRIPT="$TMP_DIR/installer_payload.sh"

echo "Instalador Waydroid: Extrayendo archivos a $TMP_DIR..."

# 2. Extraer el payload a un archivo temporal
tail -n +$PAYLOAD_LINE "$0" > "$PAYLOAD_SCRIPT"

# 3. Dar permisos de ejecuci√≥n
chmod +x "$PAYLOAD_SCRIPT"

# Crear archivo de configuraci√≥n simple para pasar el usuario
echo "WAYDROID_USER=$WAYDROID_USER" > "$TMP_DIR/config.env"

# 4. Ejecutar el payload en la terminal (sin YAD)
"$PAYLOAD_SCRIPT"

# 5. Limpiar el directorio temporal al salir
rm -rf "$TMP_DIR"

exit $?

# --- PAYLOAD START ---
EOF_WRAPPER

# -----------------------------------------------------------------------------
# 2. Adjuntar el Payload de Instalaci√≥n (SOLO TERMINAL)
# -----------------------------------------------------------------------------
cat >> "$OUTPUT_FILE" << 'EOF_PAYLOAD_MODIFIED'
#!/bin/bash
# Script de instalaci√≥n de Waydroid (Payload interno - SOLO TERMINAL)
# -----------------------------------------------------------------------------
set -e

HELPER_SCRIPT_PATH="/usr/local/bin/waydroid-gservices-helper.sh"
RESTART_SCRIPT_PATH="/usr/local/bin/waydroid-restart.sh"
DESKTOP_ACTIVATOR_PATH="/usr/share/applications/Waydroid_Gplay_Activator.desktop"
DESKTOP_RESTART_PATH="/usr/share/applications/Waydroid_Restart.desktop"

# Obtener el nombre de usuario del wrapper
WAYDROID_USER=""
if [ -f "$PWD/config.env" ]; then
    . "$PWD/config.env"
fi
if [ -z "$WAYDROID_USER" ]; then
    WAYDROID_USER=$(logname)
fi

echo "üöÄ Iniciando la instalaci√≥n automatizada de Waydroid..."
echo "---"

# -----------------------------------------------------------------------------
# 0. Verificaci√≥n de Compatibilidad
# -----------------------------------------------------------------------------
echo "[0/7] Verificando la compatibilidad del sistema operativo..."

if [ -f /etc/os-release ]; then
    . /etc/os-release
else
    echo "‚ùå Error: No se pudo determinar el sistema operativo. Abortando."
    exit 1
fi

if [ "$ID" != "debian" ]; then
    echo "‚ùå Error: Distribuci√≥n no compatible. Este instalador es para Debian (versi√≥n 12 o superior). ID: $ID"
    exit 1
fi

REQUIRED_VERSION=12
CURRENT_VERSION=${VERSION_ID%.*}

if [ "$CURRENT_VERSION" -lt "$REQUIRED_VERSION" ]; then
    echo "‚ùå Error: Versi√≥n de Debian no compatible. Versi√≥n m√≠nima requerida: Debian $REQUIRED_VERSION. Actual: $CURRENT_VERSION"
    exit 1
fi
echo "‚úÖ Sistema operativo compatible: Debian $CURRENT_VERSION."
echo "---"


# -----------------------------------------------------------------------------
# 1. Instalaci√≥n de Pre-requisitos
# -----------------------------------------------------------------------------
echo "[1/7] Instalando paquetes pre-requisitos: curl, ca-certificates, ufw..."
apt update
if ! apt install curl ca-certificates ufw -y; then
    echo "‚ùå Error al instalar paquetes base."
    exit 1
fi
echo "‚úÖ Paquetes pre-requisitos instalados."
echo "---"


# -----------------------------------------------------------------------------
# 2. A√±adir el Repositorio Oficial de Waydroid
# -----------------------------------------------------------------------------
WAYDROID_DISTRO_ARG="bookworm"
echo "[2/7] A√±adiendo el repositorio oficial de Waydroid (forzando '$WAYDROID_DISTRO_ARG')..."
if ! curl -s [https://repo.waydro.id](https://repo.waydro.id) | bash -s "$WAYDROID_DISTRO_ARG"; then
    echo "‚ùå Error al a√±adir el repositorio de Waydroid."
    exit 1
fi
apt update
echo "‚úÖ Repositorio de Waydroid a√±adido."
echo "---"


# -----------------------------------------------------------------------------
# 3. Instalaci√≥n de Waydroid
# -----------------------------------------------------------------------------
echo "[3/7] Instalando Waydroid..."
if ! apt install waydroid -y; then
    echo "‚ùå Error al instalar el paquete 'waydroid'."
    exit 1
fi
echo "‚úÖ Waydroid instalado correctamente."
echo "---"


# -----------------------------------------------------------------------------
# 3.1 Instalaci√≥n de python3-pyclipper para que funcione el copy/paste
#     entre waydroid y linux
# -----------------------------------------------------------------------------

apt install -t python3-pyclipper

# -----------------------------------------------------------------------------
# 4. Configuraci√≥n y Activaci√≥n del Firewall (UFW)
# -----------------------------------------------------------------------------
echo "[4/7] Configurando firewall UFW..."
ufw allow 53/udp
ufw allow 53/tcp
ufw allow 67/udp
ufw default allow FORWARD

# A√ëADIR REGLA PARA ESCRITORIO REMOTO (RDP - Puerto 3389)
ufw allow 3389/tcp

if ! ufw status | grep -q "Status: active"; then
    ufw --force enable
fi
echo "‚úÖ UFW configurado y activo."
echo "---"


# -----------------------------------------------------------------------------
# 5. Creaci√≥n del Script Auxiliar de Activaci√≥n (waydroid-gservices-helper.sh)
# -----------------------------------------------------------------------------
echo "[5/7] Creando script auxiliar de activaci√≥n de Google Play..."

# INTEGRACI√ìN EXACTA del script proporcionado
cat > "$HELPER_SCRIPT_PATH" << 'EOF_HELPER'
#!/bin/bash
# waydroid-gservices-helper.sh (Terminal Version)
# Extrae el ID de Android y muestra las instrucciones.
clear
echo ""
echo "======================================================================"
echo "          Activaci√≥n de Google Play Services para Waydroid"
echo "======================================================================"
echo "‚ùó IMPORTANTE: Antes de continuar, inicie Waydroid al menos una vez:"
echo "              Escriba 'waydroid show-full-ui' y espere a que cargue."
echo "              Luego ci√©rrelo antes de continuar."
echo "----------------------------------------------------------------------"
echo "Se requiere su contrase√±a de usuario para acceder a la ID de Android (sudo)."
read -r -s -p "Contrase√±a de usuario: " SUDO_PASS
echo ""

# Intentar obtener el Android ID usando la contrase√±a con sudo -kS (no guardada)
ANDROID_ID=$(echo "$SUDO_PASS" | sudo -kS waydroid shell -- sh -c "sqlite3 /data/data/*/*/gservices.db 'select value from main where name = \"android_id\";'" 2>/dev/null | tail -n 1)
echo ANDROID_ID=$ANDROID_ID
# Limpiar la variable de contrase√±a
SUDO_PASS=""

# Validar la salida: buscamos un n√∫mero de 16 d√≠gitos hexadecimales.
if [ -z "$ANDROID_ID" ]; then
    echo "‚ùå ERROR CR√çTICO: No se pudo obtener el Android ID (debe ser un n√∫mero de 16 d√≠gitos)."
    echo "   Causas: Waydroid no iniciado, contrase√±a incorrecta, o base de datos no creada."
    echo "   Por favor, inicie Waydroid, int√©ntelo de nuevo."
    echo "----------------------------------------------------------------------"
    exit 1
fi

echo ""
echo "‚úÖ ID DE ANDROID EXTRA√çDA CORRECTAMENTE:"
echo "----------------------------------------------------------------------"
echo "Android ID: $ANDROID_ID"
echo "----------------------------------------------------------------------"
echo "PASO 2: REGISTRO DE GOOGLE PLAY SERVICES"
echo "----------------------------------------------------------------------"
echo "a. Copia la ID de Android que aparece arriba."
echo "b. Abre el siguiente enlace en tu navegador:"
echo "		[https://www.google.com/android/uncertified](https://www.google.com/android/uncertified)"
echo "c. Pega la ID de Android en el campo de 'Google Services Framework Android ID'."
echo "d. Presiona 'Register'."
echo "----------------------------------------------------------------------"
echo "PASO 3: REINICIAR WAYDROID"
echo "----------------------------------------------------------------------"
echo "Despu√©s de registrar la ID y esperar unos minutos, usa el lanzador 'Waydroid Restart'."
echo "Reinicia seleccionando en las Apps Waydroid Restart"
echo "----------------------------------------------------------------------"
echo ""
read -r -p "Presiona [Enter] para finalizar la visualizaci√≥n de este mensaje."
exit 0
EOF_HELPER

chmod +x "$HELPER_SCRIPT_PATH"
echo "‚úÖ Script auxiliar $HELPER_SCRIPT_PATH creado."
echo "---"


# -----------------------------------------------------------------------------
# 6. Creaci√≥n del Script de Reinicio (waydroid-restart.sh)
# -----------------------------------------------------------------------------
echo "[6/7] Creando script de reinicio r√°pido de Waydroid..."

cat > "$RESTART_SCRIPT_PATH" << 'EOF_RESTART'
#!/bin/bash
# waydroid-restart.sh
# Detiene la sesi√≥n, espera y la reinicia.

echo "======================================================================"
echo "                Reiniciando Waydroid (Stop -> Start)"
echo "======================================================================"

# Detener la sesi√≥n
echo "1. Deteniendo sesi√≥n de Waydroid..."
waydroid session stop

# Esperar 3 segundos
echo "2. Esperando 3 segundos..."
sleep 3

# Iniciar la sesi√≥n
echo "3. Iniciando nueva sesi√≥n de Waydroid..."
waydroid session start

echo "‚úÖ Sesi√≥n de Waydroid reiniciada. Cierre esta terminal y ejecute Waydroid."
read -r -p "Presione [Enter] para cerrar."
EOF_RESTART

chmod +x "$RESTART_SCRIPT_PATH"
echo "‚úÖ Script de reinicio $RESTART_SCRIPT_PATH creado."
echo "---"


# -----------------------------------------------------------------------------
# 7. Creaci√≥n de Launchers (.desktop)
# -----------------------------------------------------------------------------
echo "[7/7] Creando lanzadores .desktop..."

# Launcher para el Activador de Google Play (Terminal)
cat > "$DESKTOP_ACTIVATOR_PATH" << EOF_ACTIVATOR
[Desktop Entry]
Version=1.0
Type=Application
Name=Waydroid GPlay Services Activator
Comment=Obtiene el Android ID para activar Google Play Services (Requiere Terminal)
Exec=x-terminal-emulator -e $HELPER_SCRIPT_PATH
Icon=android
Terminal=false
Categories=System;
Keywords=Waydroid;Android;Google Play;
EOF_ACTIVATOR
echo "   -> Launcher: $DESKTOP_ACTIVATOR_PATH creado."


# Launcher para el Reinicio R√°pido
cat > "$DESKTOP_RESTART_PATH" << EOF_RESTART_LAUNCHER
[Desktop Entry]
Version=1.0
Type=Application
Name=Waydroid Restart
Comment=Detiene, espera e inicia la sesi√≥n de Waydroid (√ötil despu√©s de activar Google Play)
Exec=x-terminal-emulator -e $RESTART_SCRIPT_PATH
Icon=android
Terminal=false
Categories=System;
Keywords=Waydroid;Android;Reiniciar;
EOF_RESTART_LAUNCHER
echo "   -> Launcher: $DESKTOP_RESTART_PATH creado."
echo "‚úÖ Lanzadores .desktop creados."
echo "---"


# -----------------------------------------------------------------------------
# 8. Finalizaci√≥n
# -----------------------------------------------------------------------------
echo "üéâ [FINALIZADO] Instalaci√≥n de Waydroid completada."
echo ""
echo "‚ùó IMPORTANTE: Es necesario reiniciar el sistema."
echo "   Para la activaci√≥n final de Google Play, use los lanzadores despu√©s de reiniciar."
echo ""
read -r -p "¬øDesea reiniciar ahora? (s/n): " REBOOT_CHOICE

if [[ "$REBOOT_CHOICE" =~ ^[Ss]$ ]]; then
    echo "Reiniciando el sistema en 5 segundos..."
    sleep 5
    reboot
else
    echo "Por favor, reinicie su sistema manualmente lo antes posible para completar la instalaci√≥n."
fi

exit 0
EOF_PAYLOAD_MODIFIED

# 3. Dar permisos de ejecuci√≥n al instalador final
chmod +x "$OUTPUT_FILE"

echo "---"
echo "‚úÖ Generaci√≥n finalizada. El archivo listo para distribuir es: $OUTPUT_FILE"
echo "Para usarlo, ejecute: ./$OUTPUT_FILE (se encargar√° de todo en la terminal)."
